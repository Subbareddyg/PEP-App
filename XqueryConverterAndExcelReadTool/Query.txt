WITH Input(ORIN) AS
  ( SELECT '231236029' ORIN /*-- 240525308,--221712861*/
  FROM dual
  ) ,
  petcatalog AS
  (SELECT pet.mdmid ORIN,
    ias.CATEGORY_ID,
    ias.CATEGORY_DESC,
    ias.CATEGORY_NAME,
    pet.ENTRY_TYPE
  FROM Input inp,
    VENDORPORTAL.ADSE_PET_CATALOG pet,
    XMLTABLE( 'for $j in $XML_DATA/pim_entry/pet_entry_header/category_paths/category[last()]  let           $categoryid := $j//pk,        $categorydesc := $j//path,        $categoryname := tokenize(tokenize($j//path, "///")[last()],"-")[last()]        return         <category>      <pk>{$categoryid}</pk>      <path>{$categorydesc}</path>      <name>{$categoryname}</name>     </category>' PASSING pet.XML_DATA AS "XML_DATA" COLUMNS CATEGORY_ID VARCHAR(100) path '/category/pk', CATEGORY_DESC VARCHAR(100) path '/category/path', CATEGORY_NAME VARCHAR(100) path '/category/name') ias
  WHERE pet.mdmid = inp.ORIN
  ) ,
  petitemcatalog AS
  (SELECT pc.ORIN,
    pc.CATEGORY_ID,
    pc.CATEGORY_NAME,
    ibs.ITEM_CATEGORY_ID,
    pc.ENTRY_TYPE
  FROM petcatalog pc,
    VENDORPORTAL.ADSE_ITEM_CATALOG aic,
    XMLTABLE( 'for $j in $XML_DATA/pim_entry/item_header/category_paths/category  let           $itemcategoryid := $j//pk,        $itemcategorydesc := $j//path,        $itemcategoryname := tokenize($j//path, "///")[1]        return         <category>        <pk>{$itemcategoryid}</pk>        <path>{$itemcategorydesc}</path>        <name>{$itemcategoryname}</name>       </category>' PASSING aic.XML_DATA AS "XML_DATA" COLUMNS ITEM_CATEGORY_ID VARCHAR(100) path '/category/pk', ITEM_CATEGORY_DESC VARCHAR(100) path '/category/path', ITEM_CATEGORY_NAME VARCHAR(100) path '/category/name') ibs
  WHERE pc.ORIN                     = aic.MDMID
  AND ( pc.ENTRY_TYPE              IS NULL
  OR pc.ENTRY_TYPE                 IN ('Style','StyleColor','SKU', 'ComplexPack', 'PackColor' , '' ) )
  AND ( pc.ENTRY_TYPE              IS NULL
  OR pc.ENTRY_TYPE                 IN ('Style','StyleColor','SKU', 'ComplexPack', 'PackColor', '') )
  AND UPPER(ibs.ITEM_CATEGORY_NAME) = UPPER('Merchandise_Hierarchy')
  ) ,
  petitemmerch AS
  (SELECT pic.ORIN,
    pic.CATEGORY_ID,
    pic.CATEGORY_NAME,
    pic.ITEM_CATEGORY_ID,
    ics.SUB_CLASS,
    pic.ENTRY_TYPE
  FROM petitemcatalog pic,
    VENDORPORTAL.ADSE_MERCHANDISE_HIERARCHY amh,
    XMLTABLE( 'for $j in $XML_DATA/pim_category/merchandise_category_header      let           $subclass := tokenize($j//full_path, "///")[last()]              return           <merchandise_category_header>          <full_path>{$subclass}</full_path>         </merchandise_category_header>' PASSING amh.XML_DATA AS "XML_DATA" COLUMNS SUB_CLASS VARCHAR(100) path '/merchandise_category_header/full_path') ics
  WHERE pic.ITEM_CATEGORY_ID = amh.MDMID
  AND ( pic.ENTRY_TYPE      IS NULL
  OR pic.ENTRY_TYPE         IN ('Style','StyleColor','SKU', 'ComplexPack', 'PackColor' , '' ) )
  AND ( pic.ENTRY_TYPE      IS NULL
  OR pic.ENTRY_TYPE         IN ('Style','StyleColor','SKU', 'ComplexPack', 'PackColor', '') )
  )
SELECT pim.ORIN ORIN,
  pim.CATEGORY_ID PET_CATEGORY_ID,
  pim.CATEGORY_NAME PET_CATEGORY_NAME,
  pim.SUB_CLASS SUB_CLASS,
  ids.MERCH_CATEGORY_ID MERCH_CATEGORY_ID,
  ids.MERCH_CATEGORY_NAME MERCH_CATEGORY_NAME
FROM petitemmerch pim,
  VENDORPORTAL.ADSE_MERCHANDISE_HIERARCHY amh1,
  XMLTABLE( 'for $j in $XML_DATA/pim_category/entry/Merchandise_Hier_Spec/IPH_Category_Mappings  let         $leafnode7 := $j//Level_7,        $leafnode6 := if(string-length($leafnode7) = 0) then $j//Level_6 else $leafnode7,        $leafnode5 := if(string-length($leafnode6) = 0) then $j//Level_5 else $leafnode6,        $leafnode4 := if(string-length($leafnode5) = 0) then $j//Level_4 else $leafnode5,        $leafnode3 := if(string-length($leafnode4) = 0) then $j//Level_3 else $leafnode4,        $leafnode2 := if(string-length($leafnode3) = 0) then $j//Level_2 else $leafnode3,        $leafnode1 := if(string-length($leafnode2) = 0) then $j//Level_1 else $leafnode2,        $merchcategoryid := tokenize($leafnode1,"-")[1],        $merchcategoryname := tokenize($leafnode1,"-")[last()]        return         <IPH_Category_Mappings>      <category_id>{$merchcategoryid}</category_id>      <category_name>{$merchcategoryname}</category_name>     </IPH_Category_Mappings>' PASSING amh1.XML_DATA AS
  "XML_DATA" COLUMNS MERCH_CATEGORY_ID VARCHAR(100) path '/IPH_Category_Mappings/category_id', MERCH_CATEGORY_NAME VARCHAR(100) path '/IPH_Category_Mappings/category_name') ids
WHERE pim.ITEM_CATEGORY_ID = amh1.MDMID
AND ( pim.ENTRY_TYPE      IS NULL
OR pim.ENTRY_TYPE         IN ('Style','StyleColor','SKU', 'ComplexPack', 'PackColor', '' ) )
AND ( pim.ENTRY_TYPE      IS NULL
OR pim.ENTRY_TYPE         IN ('Style','StyleColor','SKU', 'ComplexPack', 'PackColor', '') ) ;